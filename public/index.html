<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Кальянный Миксер</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
  --bg:#000;--panel:#0c0c0c;--panel-2:#151515;
  --border:#242424;--text:#fff;--muted:#f0e9db;--accent:#f0b85a;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;background:var(--bg);color:var(--text);
font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;overflow-y:auto;}
header{text-align:center;margin-top:10px;}
.tabs{display:grid;gap:6px;background:var(--panel-2);padding:6px;border-radius:10px;
grid-template-columns:1fr 1fr 1fr;max-width:400px;margin:10px auto;}
.tab-btn{background:transparent;border:none;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;}
.tab-btn.active{background:var(--accent);color:#000}
.container{max-width:420px;margin:0 auto;padding:10px;}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;margin-bottom:10px;padding:12px;}
input,select,button,textarea{width:100%;margin-top:6px;padding:8px;border-radius:8px;border:1px solid var(--border);background:#111;color:#fff;}
button{cursor:pointer;}
</style>
</head>
<body>
<header>
  <h2>Кальянный Миксер</h2>
  <div id="user-info"></div>
</header>
<div class="tabs" id="tabs"></div>
<div class="container" id="content"></div>

<script>
const tg = window.Telegram?.WebApp || null;
let user = tg?.initDataUnsafe?.user || {};
let username = (user.username||"guest").toLowerCase();
let name = user.first_name||"Гость";
const ADMINS=["tutenhaman","brgmnstrr"];
const IS_ADMIN = ADMINS.includes(username);
document.getElementById("user-info").innerText=`Привет, ${name} (${IS_ADMIN?'Админ':'Гость'})`;

const tabs = [
  {id:"mixes",label:"Миксы"},
  {id:"builder",label:"Конструктор"},
  ...(IS_ADMIN?[{id:"admin",label:"Админ"}]:[])
];
const tabsDiv=document.getElementById("tabs");
tabs.forEach(t=>{
  const b=document.createElement("button");
  b.className="tab-btn"+(t.id==="mixes"?" active":"");
  b.innerText=t.label;
  b.onclick=()=>selectTab(t.id);
  tabsDiv.appendChild(b);
});
let currentTab="mixes";
function selectTab(id){
  currentTab=id;
  document.querySelectorAll(".tab-btn").forEach(btn=>btn.classList.remove("active"));
  [...tabsDiv.children].find(b=>b.innerText===tabs.find(x=>x.id===id).label).classList.add("active");
  render();
}

async function apiGet(url){try{const r=await fetch(url);return await r.json();}catch{return [];}}
async function apiPost(url,data){await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});}
async function apiDelete(url){await fetch(url,{method:"DELETE"});}

let brands=[],mixes=[];
async function loadData(){
  brands=await apiGet("/api/library");
  mixes=await apiGet("/api/mixes");
  render();
}
loadData();

function render(){
  const c=document.getElementById("content");
  c.innerHTML="";
  if(currentTab==="mixes") renderMixes(c);
  else if(currentTab==="builder") renderBuilder(c);
  else if(currentTab==="admin" && IS_ADMIN) renderAdmin(c);
}

/* ---------- MIXES TAB ---------- */
function renderMixes(c){
  const rec=document.createElement("div");
  rec.className="card";
  rec.innerHTML=`<h3>Рекомендации</h3>
  <select id="recTaste"><option value="">Выбери вкус</option><option>сладкий</option><option>кислый</option><option>мятный</option><option>пряный</option></select>
  <select id="recStrength"><option value="">Выбери крепость</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
  <button id="recBtn">Показать</button><div id="recList"></div>`;
  c.appendChild(rec);
  document.getElementById("recBtn").onclick=()=>{
    const t=document.getElementById("recTaste").value,s=document.getElementById("recStrength").value;
    const flt=mixes.filter(m=>(!t||m.taste.includes(t))&&(!s||m.strength==s));
    const rL=document.getElementById("recList");
    rL.innerHTML=flt.map(m=>`<div>${m.name} (${m.taste}, ${m.strength})</div>`).join("")||"Нет подходящих";
  };

  const list=document.createElement("div");
  list.className="card";
  list.innerHTML=`<h3>Библиотека миксов</h3>`;
  mixes.forEach(m=>{
    const div=document.createElement("div");
    div.style.borderBottom="1px solid #333";div.style.padding="6px 0";
    div.innerHTML=`<b>${m.name}</b> — ${m.taste} (${m.strength})<br>Автор: ${m.author}
    <div><button class='like' data-id='${m.id}'>❤️ ${m.likes?.length||0}</button>
    ${IS_ADMIN?`<button class='delmix' data-id='${m.id}'>Удалить</button>`:""}</div>`;
    list.appendChild(div);
  });
  c.appendChild(list);
  c.querySelectorAll(".like").forEach(b=>b.onclick=()=>toggleLike(b.dataset.id));
  if(IS_ADMIN)c.querySelectorAll(".delmix").forEach(b=>b.onclick=()=>delMix(b.dataset.id));
}
async function toggleLike(id){await apiPost(`/api/mixes/${id}/like`,{user:username});loadData();}
async function delMix(id){await apiDelete(`/api/mixes/${id}`);loadData();}

/* ---------- BUILDER TAB ---------- */
function renderBuilder(c){
  const card=document.createElement("div");card.className="card";
  card.innerHTML=`<h3>Конструктор</h3>
  <input id='mixName' placeholder='Название микса'>
  <input id='search' placeholder='Поиск вкуса'>
  <div id='flavors'></div>
  <button id='saveMix'>Сохранить микс</button>
  <div id='result'></div>`;
  c.appendChild(card);
  const search=document.getElementById("search"),flv=document.getElementById("flavors"),res=document.getElementById("result");
  function updateList(){
    const q=search.value.toLowerCase();
    let html="";
    brands.forEach(b=>{
      b.flavors.filter(f=>!q||f.title.toLowerCase().includes(q)||f.taste.toLowerCase().includes(q))
        .forEach(f=>html+=`<div><input type='checkbox' value='${b.name}|${f.title}|${f.profile}|${f.strength}'> ${b.name} - ${f.title} (${f.profile}, ${f.strength})</div>`);
    });
    flv.innerHTML=html||"Нет совпадений";
  }
  search.oninput=updateList;updateList();
  document.getElementById("saveMix").onclick=async()=>{
    const name=document.getElementById("mixName").value||"Без названия";
    const sel=[...flv.querySelectorAll("input:checked")].map(x=>x.value.split("|"));
    if(sel.length==0)return;
    const prof=[...new Set(sel.map(x=>x[2]))].join(", ");
    const str=Math.round(sel.map(x=>+x[3]).reduce((a,b)=>a+b,0)/sel.length);
    await apiPost("/api/mixes",{name,author:username,composition:sel.map(x=>x[0]+" "+x[1]),taste:prof,strength:str});
    res.innerHTML=`<p>Микс "${name}" сохранён! (${prof}, ${str})</p>`;
    loadData();
  };
}

/* ---------- ADMIN TAB ---------- */
function renderAdmin(c){
  const card=document.createElement("div");card.className="card";
  card.innerHTML=`<h3>Добавить бренд</h3><input id='bName' placeholder='Название бренда'><button id='addBrand'>Добавить бренд</button>`;
  c.appendChild(card);
  document.getElementById("addBrand").onclick=async()=>{
    const n=document.getElementById("bName").value;if(!n)return;
    await apiPost("/api/library",{action:"addBrand",name:n});loadData();
  };
  const add=document.createElement("div");add.className="card";
  add.innerHTML=`<h3>Добавить вкус</h3>
  <select id='selBrand'><option value=''>Выбери бренд</option>${brands.map(b=>`<option>${b.name}</option>`).join("")}</select>
  <input id='flTitle' placeholder='Название вкуса'>
  <input id='flTaste' placeholder='Какой вкус'>
  <input id='flProfile' placeholder='Описание (сладкий, кислый...)'>
  <input id='flStrength' type='number' placeholder='Крепость 1-5' min='1' max='5'>
  <button id='addFlavor'>Добавить вкус</button>`;
  c.appendChild(add);
  document.getElementById("addFlavor").onclick=async()=>{
    const b=document.getElementById("selBrand").value;
    const t=document.getElementById("flTitle").value;
    const ta=document.getElementById("flTaste").value;
    const p=document.getElementById("flProfile").value;
    const s=document.getElementById("flStrength").value;
    if(!b||!t)return;
    await apiPost("/api/library",{action:"addFlavor",brand:b,flavor:{title:t,taste:ta,profile:p,strength:+s}});
    loadData();
  };
  const rem=document.createElement("div");rem.className="card";
  rem.innerHTML=`<h3>Удалить вкус</h3>${brands.map(b=>`
    <details><summary>${b.name}</summary>${b.flavors.map(f=>`<div>${f.title} <button data-b='${b.name}' data-id='${f.id}'>Удалить</button></div>`).join("")}</details>`).join("")}`;
  c.appendChild(rem);
  rem.querySelectorAll("button").forEach(btn=>btn.onclick=async()=>{
    await apiDelete(`/api/library/${btn.dataset.b}/${btn.dataset.id}`);loadData();
  });
}
</script>
</body>
</html>
